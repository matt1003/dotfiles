#!/bin/bash

#
# buildwrap provides a simple wrapper around buildsys,
# intended to make build success and failures obvious.
#
# A buildsys configuration file is required to specify
# support build commands. This should be a csv file in
# the following format:
#
# target name, build directory, build command, upgrade command, target aliases
#

################################################################################
# script setup
################################################################################

set -o pipefail
shopt -s nullglob

buildsys_pid=".buildsys.pid"
buildsys_config="$HOME/.buildcmds"

tmux_bld_file="$HOME/.tmux/build"
tmux_bld_name="unknown"
tmux_bld_path="unknown"

opt_color_none=0
opt_en_upgrade=0
opt_clear_tmux=0
opt_ls_targets=0

restore_pwd=$PWD
running_pid=0
target_required=1

declare -A buildsys_dir_list
declare -A buildsys_cmd_list
declare -A upgrade_cmd_list
declare -A buildsys_aliases
specified_targets=()

################################################################################
# script functions
################################################################################

echo_error() {
  # arguments
  message=$1
  # print error message
  echo -e "${color_fail}error:${color_none} ${message}"
}

print_status() {
  # arguments
  phase=$1; status=$2; bash_color=$3; tmux_color=$4
  # print banner
  len=$((${#phase}+${#status}+7))
  printf "\n$bash_color"
  printf "%0.s*" $(seq 1 $len)
  printf "\n** ${phase^^} ${status^^} **\n"
  printf "%0.s*" $(seq 1 $len)
  printf "\n$color_none"
  # update tmux status
  if [ $TMUX ]; then
    update_tmux_status "$phase $status" "$tmux_color"
  fi
}

status_success() {
  print_status $buildsys_phase "Success" "$color_pass" "#b8bb26"
}

status_failure() {
  print_status $buildsys_phase "Failure" "$color_fail" "#fb4934"
}

status_aborted() {
  print_status $buildsys_phase "Aborted" "$color_warn" "#fabd2f"
}

exit_pass() {
  cleanup
  exit 0
}

exit_fail() {
  cleanup
  exit 1
}

exit_abort() {
  cleanup
  exit 2
}

hdl_sig_int() {
  kill_buildsys
  status_aborted
  exit_abort
}

hdl_sig_abrt() {
  sleep 0.50
  status_aborted
  exit_abort
}

kill_buildsys() {
  if [ -f $buildsys_pid ]; then
    pkill -SIGKILL -P `cat $buildsys_pid`
    sleep 0.25
    pkill -SIGKILL -P `cat $buildsys_pid`
    sleep 0.25
  fi
}

cleanup() {
  [ $running_pid -ne 0 ] && rm -f $buildsys_pid
  cd $restore_pwd
}

update_tmux_status() {
  [ -z "$2" ] && local c="#f9f5d7" || local c="$2"
  echo "#[fg=#a89984,bg=#3c3836]î‚³ $tmux_bld_name:#[fg=$c,bg=#3c3836,bold] $1 " \
    > "$tmux_bld_file-$tmux_bld_path"
}

clear_tmux_status() {
  for file in $tmux_bld_file-$1; do
    if grep -q 'Success\|Failure\|Aborted' $file; then
      rm $file
    fi
  done
}

################################################################################
# script main
################################################################################

#
# setup signal catching
#
trap hdl_sig_int SIGINT
trap hdl_sig_abrt SIGABRT

#
# process arguments
#
for arg in $@; do
  case $arg in
    '--no-output-color')
      opt_color_none=1 ;;
    '--upgrade')
      opt_en_upgrade=1 ;;
    'clear')
      opt_clear_tmux=1 ;;
    'list')
      opt_ls_targets=1 ;;
    *)
      # split out comma separated args
      IFS=',' read -r -a sarg <<< $arg
      specified_targets+=(${sarg[@]}) ;;
  esac
done

#
# define ansi color codes
#
if [ $opt_color_none -ne 0 ]; then
  strip_ansi=' | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"'
  shift
else
  color_fail="\e[31m"
  color_pass="\e[32m"
  color_warn="\e[33m"
  color_info="\e[36m"
  color_none="\e[0m"
fi

#
# check the config exists
#
if [ ! -f $buildsys_config ]; then
  echo_error "can not locate buildsys config \"$buildsys_config\""
  exit_fail
fi

#
# process the config
#
while IFS=, read -r target dir cmd upgrade aliases; do
  if [ -n  "$target" ]; then
    buildsys_dir_list["$target"]="$dir"
    buildsys_cmd_list["$target"]="$cmd"
    upgrade_cmd_list["$target"]="$upgrade"
    buildsys_aliases["$target"]="$target $aliases"
  fi
done < $buildsys_config

#
# check for tmux clear command
#
if [ $opt_clear_tmux -ne 0 ]; then
  clear_tmux_status '*'
  exit_pass
fi

#
# check for list targets command
#
if [ $opt_ls_targets -ne 0 ]; then
  printf "%-15s %s\n" "---------" "---------"
  printf "%-15s %s\n" " targets " " aliases "
  printf "%-15s %s\n" "---------" "---------"
  for target in ${!buildsys_cmd_list[@]}; do
    printf "%-15s %s\n" "$target" "${buildsys_aliases[$target]}"
  done | sort
  exit_pass
fi

#
# check target is specified
#
if [ $target_required -eq 1 ]; then
  if [ ${#specified_targets[@]} -eq 0 ]; then
     echo_error "no target specified"
     exit_fail
  fi
  # TODO: update script to handle multiple targets
  if [ ${#specified_targets[@]} -gt 1 ]; then
     echo_error "only one target can be specified"
     exit_fail
   fi
fi

#
# process specified targets
#
for target in ${!buildsys_cmd_list[@]}; do
  for alias in ${buildsys_aliases[$target]}; do
    if [ "${specified_targets[0]^^}" == "${alias^^}" ]; then
      buildsys_target=$target
      buildsys_dir=${buildsys_dir_list[$target]}
      buildsys_cmd=${buildsys_cmd_list[$target]}
      upgrade_cmd=${upgrade_cmd_list[$target]}
    fi
  done
done
if [ -z $buildsys_target ]; then
  echo_error "unknown buildsys target \"${specified_targets[0]}\""
  exit_fail
fi

#
# locate build directory
#
while [ ! -d "$PWD/$buildsys_dir" ]; do
  cd ..
  if [ $PWD == "/" ]; then
     echo_error "unable to locate buildsys directory"
     exit_fail
  fi
done
tmux_bld_name=$(basename $PWD)
tmux_bld_path=${PWD//\//%}
cd "./$buildsys_dir/"

#
# ensure build is not already running
#
if [ -f $buildsys_pid ]; then
  if ps -p `cat $buildsys_pid` > /dev/null; then
    echo_error "an instance of buildsys is already running"
    exit_fail
  else
    rm -f $buildsys_pid
  fi
fi
running_pid=1

################################################################################
# kick off the build
################################################################################

#
# update tmux status bar
#
if [ $TMUX ]; then
  update_tmux_status "Building $buildsys_target"
fi
buildsys_phase="Build"

#
# execute build command
#
#
echo -e "building target: $color_info\"$buildsys_target\"$color_none"
echo -e "build directory: $color_info\"$PWD\"$color_none"
echo -e "build command: $color_info\"$buildsys_cmd$color_none"
echo -e "build start time: $color_info`date`$color_none"
eval "$buildsys_cmd 2>&1 $strip_ansi"

#
# check build result
#
if [ $? -eq 0 ]; then
  echo -e "\nBuild Success for target $buildsys_target"
  status_success
else
  echo -e "\nBuild Failure for target $buildsys_target"
  status_failure
  exit_fail
fi

#
# build complete
#
if [ $opt_en_upgrade -eq 0 ]; then
  exit_pass
fi

################################################################################
# kick off the upgrade
################################################################################

#
# update tmux status bar
#
if [ $TMUX ]; then
  update_tmux_status "Upgrading $buildsys_target"
fi
buildsys_phase="Upgrade"

#
# execute upgrade command
#
echo -e "upgrading target: $color_info\"$buildsys_target\"$color_none"
echo -e "upgrade directory: $color_info\"$PWD\"$color_none"
echo -e "upgrade command: $color_info\"$upgrade_cmd$color_none"
echo -e "upgrade start time: $color_info`date`$color_none"
eval "$upgrade_cmd 2>&1 $strip_ansi"

#
# check upgrade result
#
if [ $? -eq 0 ]; then
  echo -e "\nUpgrade Success for target $buildsys_target"
  status_success
else
  echo -e "\nUpgrade Failure for target $buildsys_target"
  status_failure
  exit_fail
fi

#
# upgrade complete
#
exit_pass

